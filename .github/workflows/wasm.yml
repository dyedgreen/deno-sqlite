name: wasm

on:
  workflow_dispatch:
  push:
    branches:
      - "master"

jobs:
  wasm:
    runs-on: ubuntu-latest
    steps:
    - name: Install Deno
      run: curl -fsSL https://deno.land/x/install/install.sh | sh
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.head_ref }}
    - name: Build SQLite
      id: build
      run: |
        export DENO_INSTALL="/home/runner/.deno"
        export PATH="$DENO_INSTALL/bin:$PATH"
        sudo apt-get -y install --no-install-recommends tclsh gcc
        cd build
        make setup amalgamation release
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: (GitHub Action) Rebuild SQLite WASM
        file_pattern: build/sqlite.js build/sqlite.wasm
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
